<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Fnaf IRL v7.0 Final Stable</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --neon-green: #00ff41; --neon-red: #f00; --neon-purple: #f0f; }
        body { background: #000; color: var(--neon-green); font-family: 'Courier New', monospace; margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        /* UI Elements */
        .terminal { width: 600px; border: 2px solid #1a1a1a; padding: 20px; position: relative; display: none; background: #000; box-shadow: 0 0 20px rgba(0,255,65,0.1); }
        #setupOverlay { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn { padding: 12px; background: none; border: 1px solid var(--neon-green); color: var(--neon-green); cursor: pointer; font-family: inherit; font-weight: bold; text-transform: uppercase; transition: 0.2s; }
        .btn:hover { background: rgba(0, 255, 65, 0.2); }
        .btn-active { background: var(--neon-green) !important; color: #000 !important; }
        .btn-night.active { background: var(--neon-purple) !important; color: #fff !important; box-shadow: 0 0 20px var(--neon-purple); animation: blink 1s infinite; }
        .btn-red { border-color: var(--neon-red); color: var(--neon-red); }
        
        #hostStatusLog { margin-top: 15px; padding: 8px; border-top: 1px solid #222; font-size: 0.8rem; text-align: center; color: #666; }
        #clock { font-size: 12rem; text-shadow: 0 0 30px var(--neon-green); display: none; }
        #screamImg { display: none; position: fixed; inset: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 1000; }
        #winScreen { display: none; position: fixed; inset: 0; background: #000; z-index: 1100; flex-direction: column; justify-content: center; align-items: center; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="setupOverlay">
        <h1 style="font-size: 4rem; margin: 0;">FNAF IRL</h1>
        <button class="btn" style="padding: 20px 50px;" onclick="initRole('host')"> (HOST)</button>
        <button class="btn" style="padding: 20px 50px;" onclick="initRole('player')"> (PLAYER)</button>
    </div>

    <div id="hostUI" class="terminal">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <span>STATUS: <b id="statusTxt" style="color:var(--neon-red)">OFFLINE</b></span>
            <button class="btn" style="padding: 2px 10px;" onclick="toggleSettings()">锔</button>
        </div>

        <div id="settingsBox" style="display:none; border: 1px solid #333; padding: 10px; margin-bottom: 10px;">
            效小: <input type="number" id="mInp" value="1" style="width:35px">屑 <input type="number" id="sInp" value="30" style="width:35px">
            <button class="btn" style="float:right" onclick="beginNight()">START NIGHT</button>
        </div>

        <div class="grid">
            <button class="btn" onclick="playSnd('door')">STEPS</button>
            <button class="btn" onclick="playSnd('closet')">BREATH</button>
            <button id="btn-normal" class="btn" onclick="setMode('normal')">NORMAL MODE</button>
            <button id="btn-hard" class="btn" onclick="setMode('hard')">HARD MODE</button>
            <button id="nightBtn" class="btn btn-night" onclick="toggleNightmare()">NIGHTMARE</button>
            <button class="btn btn-red" onclick="triggerScream()">SCREAMER</button>
            <button class="btn btn-red" style="grid-column: span 2" onclick="fullStop()">EMERGENCY STOP</button>
        </div>
        <div id="hostStatusLog">ID: fnaf-irl-room-v7</div>
    </div>

    <div id="playerUI" style="display:none; flex-direction: column; align-items: center;">
        <div id="waitMsg" style="font-size: 1.5rem; color: #333;">WAITING FOR HOST...</div>
        <div id="clock">12:00</div>
        <img id="screamImg" src="screamer.png">
        <div id="winScreen"><div style="font-size:10rem"></div><div style="font-size:4rem; color: gold;">6 AM</div></div>
    </div>

    <audio id="snd-door" src="door.mp3" preload="auto"></audio>
    <audio id="snd-closet" src="closet.mp3" preload="auto"></audio>
    <audio id="snd-window" src="window.mp3" preload="auto"></audio>
    <audio id="snd-nightmare" src="nightmare.mp3" loop preload="auto"></audio>
    <audio id="snd-win" src="win.mp3" preload="auto"></audio>

    <script>
        const CONFIG = { roomId: 'fnaf-irl-room-v7', nTime: 10000, winDelay: 2500 };
        let peer, conn, clockInt, gameHour = 0;
        let activeMode = null, lastSnd = null, loopActive = false;

        function setHostLog(m, c = 'var(--neon-green)') {
            const l = document.getElementById('hostStatusLog');
            l.innerText = m; l.style.color = c;
        }

        function toggleSettings() {
            const s = document.getElementById('settingsBox');
            s.style.display = s.style.display === 'none' ? 'block' : 'none';
        }

        // --- CORE LOGIC ---
        function initRole(role) {
            document.getElementById('setupOverlay').style.display = 'none';
            if(role === 'host') {
                document.getElementById('hostUI').style.display = 'block';
                peer = new Peer(CONFIG.roomId);
                peer.on('open', id => setHostLog("校 ... ID: " + id));
                peer.on('connection', c => {
                    conn = c;
                    document.getElementById('statusTxt').innerText = "ONLINE";
                    document.getElementById('statusTxt').style.color = "var(--neon-green)";
                    setHostLog(" 挟效!");
                });
            } else {
                document.getElementById('playerUI').style.display = 'flex';
                peer = new Peer();
                peer.on('open', () => {
                    const connect = () => {
                        const c = peer.connect(CONFIG.roomId);
                        c.on('open', () => handlePlayerData(c));
                        c.on('error', () => setTimeout(connect, 3000));
                    };
                    connect();
                });
            }
        }

        async function audioLoop() {
            if(!loopActive) return;
            const pool = ['door', 'closet'];
            let next;
            do { next = pool[Math.floor(Math.random()*pool.length)]; } while(next === lastSnd);
            lastSnd = next;

            const a = document.getElementById('snd-'+next);
            await new Promise(r => { 
                a.currentTime = 0; a.play(); 
                a.onended = r; 
            });

            if(loopActive) {
                let d = activeMode === 'normal' ? (Math.random()*2000 + 2000) : 1000;
                setTimeout(() => { if(loopActive) audioLoop(); }, d);
            }
        }

        function setMode(m) {
            if(activeMode === m) { stopSounds(); return; }
            stopSounds();
            activeMode = m; loopActive = true;
            document.getElementById('btn-'+m).classList.add('btn-active');
            setHostLog(": " + m.toUpperCase());
            audioLoop();
        }

        function stopSounds() {
            loopActive = false; activeMode = null;
            document.getElementById('btn-normal').classList.remove('btn-active');
            document.getElementById('btn-hard').classList.remove('btn-active');
            document.getElementById('nightBtn').classList.remove('active');
            const nm = document.getElementById('snd-nightmare');
            nm.pause(); nm.currentTime = 0;
            document.querySelectorAll('audio').forEach(a => {
                if(a.id !== 'snd-window' && a.id !== 'snd-win') {
                    a.pause(); a.currentTime = 0; a.onended = null;
                }
            });
        }

        function toggleNightmare() {
            const s = document.getElementById('snd-nightmare'), b = document.getElementById('nightBtn');
            if(s.paused) {
                stopSounds();
                s.play(); b.classList.add('active');
                setHostLog("NIGHTMARE 孝!", "var(--neon-purple)");
                setTimeout(() => { if(!s.paused) triggerScream(); }, CONFIG.nTime);
            } else { stopSounds(); }
        }

        function triggerScream() {
            stopSounds(); clearInterval(clockInt);
            const s = document.getElementById('snd-window');
            s.currentTime = 0; s.play();
            if(conn) conn.send({ action: 'scream' });
            setHostLog(" 校孝", "var(--neon-red)");
        }

        function beginNight() {
            gameHour = 0; toggleSettings();
            if(conn) conn.send({ action: 'start' });
            startClock();
            setHostLog("效鞋 效小鞋");
        }

        function startClock() {
            clearInterval(clockInt);
            const ms = ((parseInt(document.getElementById('mInp').value)||0)*60 + (parseInt(document.getElementById('sInp').value)||0))*1000;
            clockInt = setInterval(() => {
                gameHour++;
                if(conn) conn.send({ action: 'time', h: gameHour });
                if(gameHour >= 6) { clearInterval(clockInt); setTimeout(victory, CONFIG.winDelay); }
            }, ms);
        }

        function victory() {
            stopSounds();
            document.getElementById('snd-win').play();
            if(conn) conn.send({ action: 'win' });
            setHostLog(": 6 校孝!", "gold");
        }

        function fullStop() { stopSounds(); clearInterval(clockInt); if(conn) conn.send({ action: 'stop' }); setHostLog("STOPPED"); }
        function playSnd(n) { const a = document.getElementById('snd-'+n); a.currentTime=0; a.play(); }

        // --- PLAYER DATA HANDLER ---
        function handlePlayerData(c) {
            c.on('data', d => {
                const img = document.getElementById('screamImg'), clk = document.getElementById('clock'), win = document.getElementById('winScreen'), wait = document.getElementById('waitMsg');
                if(d.action === 'start') { win.style.display='none'; img.style.display='none'; clk.style.display='block'; wait.style.display='none'; clk.innerText="12:00"; }
                if(d.action === 'time') clk.innerText = d.h + ":00";
                if(d.action === 'win') win.style.display='flex';
                if(d.action === 'scream') { img.src="screamer.png?t="+Date.now(); img.style.display='block'; clk.style.display='none'; setTimeout(()=>img.style.display='none', 4000); }
                if(d.action === 'stop') { clk.style.display='none'; wait.style.display='block'; }
            });
        }
    </script>
</body>
</html>